# /etc/dhcp/dhcpd.conf

# 1. Standard Global Options
default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;

# 2. Define Custom Options for iPXE and Architecture
option space ipxe;
option ipxe-encap-opts code 175 = encapsulate ipxe;
option ipxe.user-class code 77 = string;
option arch code 93 = unsigned integer 16; # RFC4578

# 3. Subnet Configuration
subnet 108.181.38.64 netmask 255.255.255.224 {
    range 108.181.38.86 108.181.38.94;
    option routers 108.181.38.65;
    option domain-name-servers 8.8.8.8;

    # Point to THIS machine (The Bootstrapper) for TFTP
    next-server 108.181.38.67;

    # 4. The Chainloading Logic
    if exists user-class and option user-class = "iPXE" {
        # STEP 2: Client is already running iPXE.
        # Send them to the local Nginx to get the handoff script.
        filename "http://108.181.38.67:8080/handoff.ipxe";
    }
    else {
        # STEP 1: Client is raw hardware (BIOS/UEFI).
        # Send them to the local TFTP server for the binary.
        if option arch = 00:07 or option arch = 00:09 {
            filename "ipxe.efi"; # x86_64 UEFI
        } else {
            filename "undionly.kpxe"; # Legacy BIOS
        }
    }
}
